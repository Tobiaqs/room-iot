import broadlink, netaddr, time
from flask import Flask, jsonify, Response, jsonify, request
from os import environ
import requests

app = Flask(__name__)

RM3Device = broadlink.rm((environ["RM3_IP"], int(environ["RM3_PORT"])), netaddr.EUI(environ["RM3_MAC"]), 0x27c2)
RM3Device.auth()

commands = {'beamer_on_off': '2600600000012392151014111412131214121312141114121337133614361436143614111436143614121312143613371337131214111412133713361412131214111436143614361500051c0001234815000c250001244815000c250001234815000d050000000000000000', 'beamer_src': '2600600000012392141213121411141213121411141213121436143614361337133614121436133713371336141214361337131214361411141213121436141114121336141214361300051d0001244813000c280001234813000c280001234813000d050000000000000000', 'beamer_menu': '2600600000012392160f14121510141213121411141213121436143613371337133614121337133713361412131214121312141114361412131214361337133713361436141213371300051f0001244813000c290001244713000c2a0001234813000d050000000000000000', 'beamer_up': '2600600000012392131214111412131214111412131214111436143614361436143614111436143614111436141213361436141213121411143614121337131214111436143614361400051c0001244813000c260001244713000c270001244813000d050000000000000000', 'beamer_down': '2600600000012491141213121411141214111412131214111436143614361436143613121436143614111412131214361411141213341612143613371337131214361436131214361400051d0001254613000c250001244713000c250001244713000d050000000000000000', 'beamer_left': '2600640000012392131214111412131214111412131214121336143614361436143614111436143515361436143613121412131214361312141114121411163414361436141114361400051f00012348130009800c00029d0001244713000c290001244813000d0500000000', 'beamer_right': '2600600000012592131214111412131214111412131214121336143614361436143614111436143614361436143613121412131214111412131214111412133713371336143614361400051d0001234814000c250001244813000c270001234813000d050000000000000000', 'beamer_back': '26006800000123921510160f15111510151114111510151114361435153515351634160f1634163416101435161015351510160f15111510153515101535151114361534163415351500051b0001244815000c240001254613000c280001234813000c280001234813000d05'}

for k, v in commands.items():
    commands[k] = bytearray.fromhex(v)

def check_cookie():
    return request.cookies.get("secret") == environ["SECRET"]

@app.route("/commands", methods=["GET"])
def get_commands():
    if not check_cookie():
        return Response("go away", mimetype="text/plain")

    return jsonify(list(commands.keys()))

@app.route("/send_command/<command>", methods=["GET"])
def send_command(command):
    if not check_cookie():
        return Response("go away", mimetype="text/plain")

    if not command in commands:
        return Response("???", mimetype="text/plain")
    
    RM3Device.send_data(commands[command])

    return Response("done", mimetype="text/plain")

if __name__ == "__main__":
    app.run(debug=("DEBUG" in environ), port=(int(environ["PORT"]) if "PORT" in environ else 5000), host="0.0.0.0")
