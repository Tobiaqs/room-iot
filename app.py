import broadlink, netaddr, time
from flask import Flask, jsonify, Response, jsonify, request
from os import environ
import requests

app = Flask(__name__)

RM3Device = broadlink.rm((environ["RM3_IP"], int(environ["RM3_PORT"])), netaddr.EUI(environ["RM3_MAC"]))
RM3Device.auth()

commands = {
    "beamer_on_off": "26004800000125901511151015101511151015101511151015351535153515341634151115351534161015101535153515351510151115101535153515101510151115341634153515000d05",
    "beamer_src": "2600500000012392160f1511151015101610160f161015101634153515351435153513131238123713371337131312371337131213371313121313121337131312131436141114361400051c0001234815000d050000000000000000",
    "beamer_ok": "2600500000012590151114111510151115101510151115101535153515351534163416101535153416101535153515101511151015101511153416101510153515351535153515351500051d0001254714000d050000000000000000",
    "beamer_up": "260048000001258f1610151015111510160f15111510151015351634163415351535151015351535151015351510163415351511151015101535151115341511151015351535153515000d05",
    "beamer_down": "2600480000012590160f151115101510151115101511151016341534163416341535160f1535163415101610151015351510161015351510153515351634151015351535160f163416000d05",
    "beamer_left": "2600500000012590151015111510151015111510151015111535153416341535153515101634153515351535153515101511151015351510151115101510153515351535151015351500051e0001254614000d050000000000000000",
    "beamer_right": "26004800000124911412121313121412131214111412131214361436143613371337121314361337133614361436141212131411141213121412131213121436143614361436133713000d05",
    "beamer_menu": "260048000001238f1612141114121312131312131312141213371336143614361436141113371434163614111313131214121312133713121411143614361436143614361411133714000d05",
    "beamer_back": "26004800000124911412131214111412131214111412131214361436133713361436141213371237141214361312143614111412131214111436141213361412133713371237143613000d05"
}

for k, v in commands.items():
    commands[k] = bytearray.fromhex(v)

def check_cookie():
    return request.cookies.get("secret") == environ["SECRET"]

@app.route("/commands", methods=["GET"])
def get_commands():
    if not check_cookie():
        return Response("go away", mimetype="text/plain")

    return jsonify(list(commands.keys()))

@app.route("/send_command/<command>", methods=["GET"])
def send_command(command):
    if not check_cookie():
        return Response("go away", mimetype="text/plain")

    if not command in commands:
        return Response("???", mimetype="text/plain")
    
    RM3Device.send_data(commands[command])

    return Response("done", mimetype="text/plain")

if __name__ == "__main__":
    app.run(debug=("DEBUG" in environ), port=(int(environ["PORT"]) if "PORT" in environ else 5000), host="0.0.0.0")
